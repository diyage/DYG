import torch
from V2.UTILS.dataset_define import *
from V2.UTILS.get_pretrained_darknet_19 import DarkNet_19, get_pretained_dark_net_19
from V2.UTILS.model_define import DarkNet19, YOLOV2Net
from V2.UTILS.trainer import YOLOV2Trainer
from PIL import ImageFile
ImageFile.LOAD_TRUNCATED_IMAGES = True

torch.cuda.set_device(0)
trainer_opt = TrainConfig()
data_opt = DataSetConfig()

dark_net = get_pretained_dark_net_19('/home/dell/PycharmProjects/YOLO/UTILS/darknet19_72.96.pth')
net = YOLOV2Net(dark_net)

trainer = YOLOV2Trainer(
    net,
    data_opt,
    trainer_opt
)

labels = ([('sheep', 325.312, 248.49066666666667, 372.736, 305.06666666666666), ('sheep', 282.88, 257.36533333333335, 330.30400000000003, 301.7386666666667), ('sheep', 267.904, 275.11466666666666, 296.192, 327.25333333333333), ('sheep', 0.8320000000000001, 269.568, 15.808, 288.4266666666667)], [('bicycle', 41.04533333333333, 99.84, 416.0, 416.0), ('person', 275.11466666666666, 217.984, 306.176, 254.592), ('person', 316.15999999999997, 171.392, 352.768, 269.568), ('bottle', 254.03733333333332, 220.48000000000002, 317.26933333333335, 280.384), ('pottedplant', 14.421333333333333, 200.512, 56.576, 259.584)], [('cat', 4.16, 24.40533333333333, 404.35200000000003, 407.12533333333334)], [('sheep', 83.72327044025158, 24.96, 251.16981132075475, 200.512), ('person', 45.78616352201258, 183.872, 219.77358490566039, 416.0)], [('dog', 70.72, 51.029333333333334, 272.896, 312.832)], [('aeroplane', 4.992, 76.2042042042042, 411.84000000000003, 298.57057057057057)], [('dog', 128.12800000000001, 169.93103448275863, 210.496, 275.86206896551727), ('dog', 138.112, 214.06896551724137, 319.488, 318.8965517241379), ('dog', 38.272, 121.37931034482759, 97.34400000000001, 195.31034482758622), ('dog', 274.56, 200.82758620689654, 322.81600000000003, 235.0344827586207), ('person', 280.384, 124.6896551724138, 331.968, 220.68965517241378)], [('cat', 134.784, 49.85123966942148, 380.224, 415.99999999999994), ('cat', 30.784000000000002, 87.6694214876033, 167.232, 343.80165289256195)], [('chair', 326.144, 259.84384384384384, 369.408, 416.0), ('chair', 4.992, 287.32732732732734, 24.96, 416.0), ('person', 21.632, 121.17717717717717, 169.728, 416.0), ('person', 216.32000000000002, 114.93093093093093, 336.96000000000004, 416.0), ('diningtable', 116.48, 278.5825825825826, 286.208, 416.0)], [('train', 2.496, 1.1093333333333333, 416.0, 416.0)], [('train', 0.8320000000000001, 150.16042780748663, 298.688, 385.96791443850265)], [('aeroplane', 0.8320000000000001, 118.69866666666667, 416.0, 414.8906666666667)], [('cat', 93.184, 3.7477477477477477, 335.296, 414.75075075075074), ('chair', 2.496, 1.249249249249249, 416.0, 416.0)], [('dog', 190.4139941690962, 56.576, 388.1049562682216, 175.55200000000002), ('dog', 171.00874635568513, 288.704, 277.73760932944606, 392.704)], [('tvmonitor', 7.488, 9.993993993993993, 415.168, 394.76276276276275), ('person', 130.624, 51.21921921921922, 265.408, 358.53453453453454)], [('dog', 40.768, 1.1243243243243244, 416.0, 351.9135135135135)], [('person', 11.648, 116.48, 170.56, 416.0), ('person', 88.19200000000001, 130.90133333333333, 201.34400000000002, 416.0), ('person', 195.52, 146.432, 297.856, 416.0), ('person', 321.98400000000004, 149.76, 406.016, 416.0), ('person', 385.216, 93.184, 416.0, 416.0)], [('tvmonitor', 233.792, 146.432, 357.76, 305.06666666666666), ('tvmonitor', 39.936, 133.12, 188.032, 326.144)], [('cat', 93.88888888888889, 82.0, 255.66666666666669, 360.0)], [('person', 12.913525498891351, 7.488, 401.2416851441242, 416.0)], [('bus', 87.36, 56.21621621621621, 325.312, 344.7927927927928)], [('boat', 202.17600000000002, 147.4114114114114, 265.408, 184.88888888888889)], [('dog', 29.12, 67.66933333333333, 251.264, 237.39733333333334)], [('sheep', 151.424, 1.249249249249249, 416.0, 413.5015015015015), ('sheep', 71.552, 1.249249249249249, 364.416, 293.5735735735736)], [('car', 88.19200000000001, 61.21321321321321, 243.776, 237.35735735735736), ('car', 153.92000000000002, 149.9099099099099, 386.048, 397.26126126126127), ('person', 374.40000000000003, 114.93093093093093, 416.0, 387.26726726726724)], [('sheep', 0.8320000000000001, 47.47147147147147, 383.552, 416.0)], [('boat', 30.521739130434785, 18.304000000000002, 380.95652173913044, 356.928)], [('cat', 0.8320000000000001, 1.1093333333333333, 416.0, 366.08)], [('chair', 0.8320000000000001, 211.88266666666667, 312.0, 416.0), ('person', 10.816, 117.58933333333333, 381.88800000000003, 416.0)], [('sheep', 1.6640000000000001, 44.97297297297297, 364.416, 416.0), ('sheep', 224.64000000000001, 193.63363363363362, 355.264, 416.0)], [('bottle', 278.72, 333.5495495495495, 292.86400000000003, 372.27627627627623), ('person', 300.35200000000003, 47.47147147147147, 381.88800000000003, 398.51051051051047), ('person', 54.080000000000005, 57.46546546546546, 141.44, 379.77177177177174), ('car', 363.584, 212.37237237237235, 416.0, 271.08708708708707)], [('motorbike', 89.85600000000001, 191.91466666666668, 330.30400000000003, 400.46933333333334), ('person', 133.12, 87.63733333333333, 198.848, 407.12533333333334), ('person', 86.528, 59.903999999999996, 187.20000000000002, 292.864)], [('dog', 219.648, 183.04, 249.60000000000002, 203.008)], [('sheep', 326.976, 210.77333333333334, 375.232, 240.72533333333334), ('sheep', 258.752, 218.53866666666667, 321.98400000000004, 265.1306666666667), ('sheep', 288.704, 211.88266666666667, 329.47200000000004, 238.50666666666666), ('sheep', 130.624, 239.61599999999999, 210.496, 287.31733333333335), ('sheep', 175.55200000000002, 198.57066666666665, 227.96800000000002, 261.80266666666665), ('sheep', 232.96, 195.24266666666665, 266.24, 215.21066666666667), ('sheep', 100.67200000000001, 174.16533333333334, 129.792, 214.10133333333332), ('sheep', 218.816, 203.008, 236.288, 226.304), ('sheep', 284.54400000000004, 200.78933333333333, 321.98400000000004, 220.75733333333332)], [('car', 29.952, 96.39024390243902, 405.184, 361.4634146341464)], [('cow', 0.8320000000000001, 1.1093333333333333, 401.856, 416.0)], [('cat', 190.52800000000002, 16.64, 350.272, 244.05333333333334), ('cat', 58.24, 228.52266666666665, 416.0, 416.0)], [('cat', 177.49333333333334, 157.24800000000002, 312.832, 259.584), ('sofa', 29.951999999999998, 223.80800000000002, 416.0, 416.0), ('person', 1.1093333333333333, 78.208, 82.09066666666666, 416.0), ('pottedplant', 57.68533333333333, 0.8320000000000001, 411.56266666666664, 266.24)], [('cat', 0.8320000000000001, 1.1093333333333333, 386.88, 416.0)], [('cow', 37.47747747747748, 130.624, 416.0, 299.52000000000004), ('person', 187.38738738738738, 40.768, 244.85285285285283, 158.08), ('person', 232.36036036036035, 42.432, 297.3213213213213, 157.24800000000002)], [('aeroplane', 145.6, 53.71771771771771, 346.112, 164.9009009009009), ('aeroplane', 196.352, 72.45645645645645, 267.904, 111.18318318318317), ('person', 322.81600000000003, 136.16816816816817, 330.30400000000003, 156.15615615615616), ('person', 330.30400000000003, 147.4114114114114, 340.288, 171.14714714714714), ('person', 314.49600000000004, 128.67267267267266, 320.32, 156.15615615615616)], [('bird', 203.008, 66.56, 414.8906666666667, 227.96800000000002)], [('cat', 113.152, 25.514666666666667, 236.288, 350.5493333333333)], [('cat', 23.296, 153.92000000000002, 272.896, 356.096)], [('aeroplane', 18.304000000000002, 21.237237237237235, 407.68, 361.033033033033)], [('motorbike', 118.976, 97.62133333333333, 308.672, 279.552)], [('boat', 192.192, 237.71428571428572, 371.072, 323.1428571428571)], [('tvmonitor', 0.8320000000000001, 1.1093333333333333, 416.0, 219.648)], [('person', 222.144, 100.94933333333333, 383.552, 416.0)], [('horse', 0.8320000000000001, 25.514666666666667, 313.664, 175.27466666666666), ('horse', 0.8320000000000001, 103.16799999999999, 209.66400000000002, 416.0), ('person', 123.968, 140.88533333333334, 377.728, 416.0)], [('person', 57.408, 150.86933333333334, 184.704, 414.8906666666667), ('person', 172.22400000000002, 86.52799999999999, 270.40000000000003, 265.1306666666667), ('chair', 113.98400000000001, 38.82666666666667, 203.008, 283.9893333333333), ('chair', 0.8320000000000001, 78.76266666666666, 80.70400000000001, 416.0)], [('cat', 98.73066666666666, 193.024, 416.0, 416.0), ('tvmonitor', 63.232, 79.872, 402.688, 352.76800000000003)], [('horse', 178.048, 26.624, 411.00800000000004, 416.0), ('bird', 131.45600000000002, 337.2373333333333, 154.752, 386.048), ('horse', 3.3280000000000003, 73.216, 44.928000000000004, 212.992), ('car', 326.976, 110.93333333333334, 416.0, 283.9893333333333)], [('motorbike', 1.6640000000000001, 11.209580838323353, 416.0, 401.05389221556885), ('person', 352.76800000000003, 1.2455089820359282, 408.512, 265.2934131736527), ('person', 190.52800000000002, 1.2455089820359282, 252.096, 134.51497005988023), ('person', 0.8320000000000001, 1.2455089820359282, 24.128, 82.20359281437125)], [('car', 105.25301204819276, 248.768, 414.7469879518072, 387.712)], [('sheep', 84.03200000000001, 186.69879518072287, 148.096, 274.4096385542168), ('sheep', 139.776, 187.95180722891564, 189.696, 214.26506024096383), ('sheep', 161.40800000000002, 194.2168674698795, 212.16, 254.36144578313252)], [('cat', 0.9519450800915332, 0.8320000000000001, 325.5652173913044, 326.976)], [('person', 253.76000000000002, 198.57066666666665, 270.40000000000003, 231.85066666666665), ('person', 107.328, 118.69866666666667, 226.304, 416.0), ('train', 0.8320000000000001, 70.99733333333333, 416.0, 416.0)], [('bicycle', 47.424, 219.648, 326.976, 416.0)], [('bird', 108.16000000000001, 93.38775510204083, 394.368, 281.37609329446065)], [('train', 0.8320000000000001, 1.1093333333333333, 295.36, 416.0)], [('horse', 116.48, 196.86760563380284, 303.68, 396.07887323943663), ('person', 6.656000000000001, 159.36901408450706, 80.70400000000001, 296.47323943661974), ('person', 374.40000000000003, 242.56901408450705, 393.536, 305.84788732394367), ('person', 397.696, 239.0535211267606, 416.0, 309.3633802816901)], [('car', 67.392, 125.35466666666666, 336.12800000000004, 302.848), ('person', 231.29600000000002, 134.22933333333333, 292.86400000000003, 302.848)], [('dog', 104.0, 64.13333333333334, 416.0, 416.00000000000006)])

from V2.UTILS.others import YOLOV2Tools


targets_offset = trainer.make_targets(labels).cuda()
targets_abs = trainer.make_targets(labels, True).cuda()

pos_off, conf_off, _ = YOLOV2Tools.split_output(targets_offset, anchor_number=5)
pos_abs, conf_abs, _ = YOLOV2Tools.split_output(targets_abs, anchor_number=5)

pos_off_to_abs_right = YOLOV2Tools.translate_to_abs_position(
    pos_off,
    data_opt.pre_anchor_w_h,
    data_opt.image_size,
    data_opt.grid_number
)

pos_off_to_abs_test = YOLOV2Tools.xywh_to_xyxy(
    pos_off,
    data_opt.pre_anchor_w_h,
    data_opt.image_size,
    data_opt.grid_number
)


pos_abs_to_off_test = YOLOV2Tools.xyxy_to_xywh(
    pos_abs,
    data_opt.pre_anchor_w_h,
    data_opt.image_size,
    data_opt.grid_number
)

mask = conf_off[0] != 0
# print(pos_abs_to_off_test[0])
# print(pos_off[0])

print(pos_abs[0][mask])
print(pos_off_to_abs_test[0][mask])

